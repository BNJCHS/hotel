{% extends "administracion/base_admin.html" %}
{% block title %}Dashboard{% endblock %}
{% block extra_js %}
{% csrf_token %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Activar reserva
  document.querySelectorAll('.activar-reserva').forEach(button => {
    button.addEventListener('click', function() {
      const reservaId = this.getAttribute('data-id');
      const button = this;
      
      // Petición AJAX para activar la reserva
      fetch(`/administracion/reservas/activar/${reservaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Actualizar UI
          button.parentNode.innerHTML = '<span class="badge bg-success">Activada</span>';
          document.getElementById('activacion-mensaje').textContent = 'Reserva activada con éxito';
          
          // Limpiar mensaje después de 3 segundos
          setTimeout(() => {
            document.getElementById('activacion-mensaje').textContent = '';
          }, 3000);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al activar la reserva');
      });
    });
  });
});
</script>
{% endblock %}
{% block content %}
<h2 class="mb-4">Dashboard</h2>

<div class="row g-3">
  <div class="col-md-3">
    <div class="card kpi-card text-white">
      <div class="card-body">
        <div class="kpi-title">Reservas</div>
        <div class="kpi-value">{{ total_reservas }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card kpi-card alt text-white">
      <div class="card-body">
        <div class="kpi-title">Ingresos</div>
        <div class="kpi-value">${{ total_ingresos }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card kpi-card text-white">
      <div class="card-body">
        <div class="kpi-title">Clientes</div>
        <div class="kpi-value">{{ total_clientes }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card kpi-card alt text-white">
      <div class="card-body">
        <div class="kpi-title">Empleados</div>
        <div class="kpi-value">{{ total_empleados }}</div>
      </div>
    </div>
  </div>
</div>
<div class="card mt-4 shadow-sm">
  <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
    <span>Últimas Reservas</span>
    <span id="activacion-mensaje" class="text-success"></span>
  </div>
  
</div>
  <div class="card-body">
    {% if reservas %}
      <table class="table table-sm">
        <thead>
          <tr><th>Cliente</th><th>Habitación</th><th>Fecha</th><th>Monto</th><th>Acciones</th></tr>
        </thead>
        <tbody>
          {% for r in reservas %}
            <tr>
              <td>{{ r.usuario.username }}</td>
              <td>{{ r.habitacion }}</td>
              <td>{{ r.fecha_reserva }}</td>
              <td>${{ r.monto }}</td>
              <td>
                {% if r.confirmada and not r.activada %}
                <button class="btn btn-sm btn-gold activar-reserva" data-id="{{ r.id }}">
                  <i class="fas fa-check-circle"></i> Activar
                </button>
                {% elif r.activada %}
                <span class="badge bg-success">Activada</span>
                {% else %}
                <span class="badge bg-warning">Pendiente</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="mb-0 text-muted">Aún no hay datos de reservas recientes.</p>
    {% endif %}
  </div>
</div>
{% endblock %}

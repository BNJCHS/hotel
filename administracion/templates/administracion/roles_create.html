{% extends "administracion/base_admin.html" %}
{% block title %}Crear Rol{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="mb-0">Crear Nuevo Rol</h2>
  <a href="{% url 'administracion:roles_list' %}" class="btn btn-secondary">Volver a Roles</a>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Información del Rol</h5>
      </div>
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
          
          <div class="mb-3">
            <label for="nombre" class="form-label">Nombre del Rol *</label>
            <input type="text" class="form-control" id="nombre" name="nombre" required 
                   placeholder="Ej: Recepcionista, Gerente, etc.">
            <div class="form-text">El nombre debe ser único en el sistema.</div>
          </div>
          
          <div class="mb-4">
            <label for="descripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="descripcion" name="descripcion" rows="3"
                      placeholder="Descripción opcional del rol y sus responsabilidades"></textarea>
          </div>
          
          <h6 class="mb-3">Permisos del Rol</h6>
          <div class="row">
            {% for modulo, permisos in permisos_por_modulo.items %}
            <div class="col-md-6 mb-4">
              <div class="card border-light">
                <div class="card-header bg-light">
                  <h6 class="mb-0">
                    <i class="fas fa-{% if modulo == 'usuarios' %}users{% elif modulo == 'habitaciones' %}bed{% elif modulo == 'empleados' %}user-tie{% elif modulo == 'planes' %}box{% elif modulo == 'promociones' %}tag{% elif modulo == 'servicios' %}concierge-bell{% elif modulo == 'huespedes' %}suitcase{% elif modulo == 'reservas' %}calendar-alt{% elif modulo == 'roles' %}shield-alt{% else %}cog{% endif %} me-2"></i>
                    {{ modulo|title }}
                  </h6>
                </div>
                <div class="card-body">
                  <div class="form-check mb-2">
                    <input class="form-check-input modulo-check" type="checkbox" 
                           id="check_all_{{ modulo }}" 
                           onchange="toggleModulo('{{ modulo }}', this.checked)">
                    <label class="form-check-label fw-bold" for="check_all_{{ modulo }}">
                      Seleccionar todos
                    </label>
                  </div>
                  <hr class="my-2">
                  {% for permiso in permisos %}
                  <div class="form-check">
                    <input class="form-check-input permiso-check permiso-{{ modulo }}" 
                           type="checkbox" 
                           value="{{ permiso.id }}" 
                           name="permisos" 
                           id="permiso_{{ permiso.id }}"
                           onchange="updateModuloCheck('{{ modulo }}')">
                    <label class="form-check-label" for="permiso_{{ permiso.id }}">
                      <span class="badge bg-{% if permiso.accion == 'ver' %}info{% elif permiso.accion == 'crear' %}success{% elif permiso.accion == 'editar' %}warning{% elif permiso.accion == 'eliminar' %}danger{% else %}secondary{% endif %} me-1">
                        {{ permiso.accion|title }}
                      </span>
                      {{ permiso.descripcion|default:permiso.accion|title }}
                    </label>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          
          <div class="d-flex justify-content-between">
            <a href="{% url 'administracion:roles_list' %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>Crear Rol
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">Ayuda</h6>
      </div>
      <div class="card-body">
        <h6>Tipos de Permisos:</h6>
        <ul class="list-unstyled">
          <li><span class="badge bg-info me-1">Ver</span> Permite visualizar información</li>
          <li><span class="badge bg-success me-1">Crear</span> Permite crear nuevos registros</li>
          <li><span class="badge bg-warning me-1">Editar</span> Permite modificar registros</li>
          <li><span class="badge bg-danger me-1">Eliminar</span> Permite borrar registros</li>
        </ul>
        
        <hr>
        
        <h6>Recomendaciones:</h6>
        <ul class="small">
          <li>Asigna solo los permisos necesarios</li>
          <li>Usa nombres descriptivos para los roles</li>
          <li>Revisa periódicamente los permisos asignados</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
function toggleModulo(modulo, checked) {
  const checkboxes = document.querySelectorAll('.permiso-' + modulo);
  checkboxes.forEach(checkbox => {
    checkbox.checked = checked;
  });
}

function updateModuloCheck(modulo) {
  const checkboxes = document.querySelectorAll('.permiso-' + modulo);
  const moduloCheck = document.getElementById('check_all_' + modulo);
  
  const totalChecked = Array.from(checkboxes).filter(cb => cb.checked).length;
  const totalCheckboxes = checkboxes.length;
  
  if (totalChecked === 0) {
    moduloCheck.checked = false;
    moduloCheck.indeterminate = false;
  } else if (totalChecked === totalCheckboxes) {
    moduloCheck.checked = true;
    moduloCheck.indeterminate = false;
  } else {
    moduloCheck.checked = false;
    moduloCheck.indeterminate = true;
  }
}

// Inicializar el estado de los checkboxes de módulo al cargar la página
document.addEventListener('DOMContentLoaded', function() {
  {% for modulo, permisos in permisos_por_modulo.items %}
  updateModuloCheck('{{ modulo }}');
  {% endfor %}
});
</script>
{% endblock %}

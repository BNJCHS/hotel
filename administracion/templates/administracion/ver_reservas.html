{% extends 'administracion/base_admin.html' %}
{% block title %}Reservas{% endblock %}

{% block content %}
<h2>Listado de reservas</h2>

<form method="get" action="{% url 'administracion:ver_reservas' %}" class="row g-2 align-items-end mb-3">
  <div class="col-auto">
    <label for="id-buscar" class="form-label mb-0">Buscar por ID</label>
    <input type="number" min="1" class="form-control" id="id-buscar" name="id" placeholder="ID de reserva" value="{{ query_id }}">
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-primary">Buscar</button>
    <a href="{% url 'administracion:ver_reservas' %}" class="btn btn-outline-secondary ms-2">Limpiar</a>
  </div>
  {% if messages %}
    <div class="col-12">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mt-2 mb-0">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
</form>

<table class="table table-striped">
  <thead>
    <tr>
      <th>ID</th>
      <th>Cliente</th>
      <th>Habitación</th>
      <th>Check-in</th>
      <th>Check-out</th>
      <th>Estado</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for reserva in reservas %}
      <tr>
        <td>{{ reserva.id }}</td>
        <td>{{ reserva.usuario.get_full_name|default:reserva.usuario.username }}</td>
        <td>{{ reserva.tipo_habitacion.nombre }} ({{ reserva.cantidad_habitaciones }} hab.)</td>
        <td>{{ reserva.check_in }}</td>
        <td>{{ reserva.check_out }}</td>
        <td>
          {% if reserva.estado == 'activa' %}
            <span class="badge bg-success">Activa</span>
          {% elif reserva.estado == 'confirmada' %}
            <span class="badge bg-info">Confirmada</span>
          {% elif reserva.estado == 'cancelada' %}
            <span class="badge bg-danger">Cancelada</span>
          {% else %}
            <span class="badge bg-warning">Pendiente</span>
          {% endif %}
        </td>
        <td>
          {% if reserva.estado == 'pendiente' %}
            <form method="post" action="{% url 'administracion:confirmar_reserva_admin' reserva.id %}" style="display:inline;">
              {% csrf_token %}
              <button class="btn btn-sm btn-success" type="submit">Confirmar</button>
            </form>

            <form method="post" action="{% url 'administracion:rechazar_reserva_admin' reserva.id %}" style="display:inline; margin-left:5px;">
              {% csrf_token %}
              <button class="btn btn-sm btn-danger" type="submit"
                      onclick="return confirm('¿Seguro que querés rechazar la reserva?')">
                Rechazar
              </button>
            </form>
          {% elif reserva.estado == 'confirmada' and reserva.check_in == hoy %}
            <form method="post" action="{% url 'administracion:activar_reserva' reserva.id %}" style="display:inline;">
              {% csrf_token %}
              <input type="text" name="codigo_checkin" placeholder="Código de check-in" class="form-control form-control-sm mb-2" required>
              <button class="btn btn-sm btn-primary" type="submit">Activar reserva</button>
            </form>
          {% elif reserva.estado == 'activa' and reserva.check_out == hoy %}
            <form method="post" action="{% url 'administracion:finalizar_reserva_admin' reserva.id %}" style="display:inline;">
              {% csrf_token %}
              <button class="btn btn-sm btn-warning" type="submit">Checkout (finalizar)</button>
            </form>
          {% else %}
            <span class="text-muted">Sin acciones</span>
          {% endif %}
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="7">No hay reservas</td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% endblock %}

